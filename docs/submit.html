<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check einreichen ‚Äì Satoshis f√ºr Berlin</title>

  <!-- CSV parsing library -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --btc-orange: #F7931A;
      --btc-orange-dark: #e8850f;
      --bg-dark: #0f0f1a;
      --bg-card: #1a1a2e;
      --bg-input: #0f0f1a;
      --border-color: #2d2d44;
      --text-primary: #e0e0e0;
      --text-secondary: #888;
      --text-muted: #666;
      --success-green: #22c55e;
      --success-bg: rgba(34, 197, 94, 0.1);
      --error-red: #ef4444;
      --error-bg: rgba(239, 68, 68, 0.1);
      --radius: 8px;
      --radius-lg: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    a { color: var(--btc-orange); }
    a:hover { color: var(--btc-orange-dark); }

    /* Header */
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-color);
      padding: 20px;
    }

    .header-content {
      max-width: 640px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }

    .header h1 .btc-icon {
      width: 32px;
      height: 32px;
      background: var(--btc-orange);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      color: #000;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      text-decoration: none;
      color: var(--text-primary);
      background: var(--bg-dark);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn:hover {
      background: var(--bg-card);
      border-color: var(--btc-orange);
      color: var(--text-primary);
    }

    /* Main */
    .main {
      max-width: 640px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    /* Form card */
    .form-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 24px;
    }

    /* Tabs */
    .form-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .form-tab {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      color: var(--text-secondary);
      cursor: pointer;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s ease;
    }

    .form-tab:hover {
      border-color: var(--btc-orange);
      color: var(--text-primary);
    }

    .form-tab.active {
      background: var(--btc-orange);
      color: #000;
      border-color: var(--btc-orange);
      font-weight: 600;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
    }

    /* Section titles */
    .section-title {
      color: var(--btc-orange);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 24px 0 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .section-title:first-of-type {
      margin-top: 0;
    }

    /* Fields */
    .field {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-primary);
      font-size: 14px;
    }

    label .required {
      color: var(--btc-orange);
    }

    .field-hint {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .field-hint a {
      color: var(--btc-orange);
    }

    input[type="text"],
    input[type="url"],
    input[type="datetime-local"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      background: var(--bg-dark);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.15s ease;
    }

    input[type="datetime-local"]::-webkit-calendar-picker-indicator {
      filter: invert(0.7);
      cursor: pointer;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--btc-orange);
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    /* Privacy notice */
    .privacy-notice {
      background: rgba(247, 147, 26, 0.1);
      border: 1px solid rgba(247, 147, 26, 0.3);
      border-radius: var(--radius);
      padding: 16px;
      margin: 24px 0 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .privacy-notice strong {
      color: var(--btc-orange);
    }

    .privacy-notice a {
      color: var(--btc-orange);
    }

    /* Submit button */
    button[type="submit"] {
      width: 100%;
      padding: 14px;
      background: var(--btc-orange);
      color: #000;
      border: none;
      border-radius: var(--radius);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
      margin-top: 8px;
    }

    button[type="submit"]:hover {
      background: var(--btc-orange-dark);
    }

    button[type="submit"]:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    /* Modal overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 32px;
      max-width: 480px;
      width: 100%;
      text-align: center;
      position: relative;
      border: 1px solid var(--border-color);
    }

    .modal-content.success {
      border-color: var(--success-green);
    }

    .modal-content.error {
      border-color: var(--error-red);
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .modal-content.success .modal-title {
      color: var(--success-green);
    }

    .modal-content.error .modal-title {
      color: var(--error-red);
    }

    .modal-body {
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .modal-body a {
      color: var(--btc-orange);
      word-break: break-all;
    }

    .modal-gif {
      width: 200px;
      height: auto;
      border-radius: var(--radius);
      margin: 0 auto 20px auto;
      display: block;
    }

    .modal-btn {
      display: inline-block;
      background: var(--btc-orange);
      color: #000;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: var(--radius);
      text-decoration: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-btn:hover {
      background: var(--btc-orange-dark);
      color: #000;
    }

    /* Legacy status message (hidden, kept for form reset) */
    .status-message {
      display: none;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 24px 20px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .footer a {
      color: var(--text-secondary);
    }

    .footer a:hover {
      color: var(--btc-orange);
    }

    /* Pre-filled field highlight */
    .field-prefilled input {
      border-color: var(--btc-orange);
      background: rgba(247, 147, 26, 0.1);
    }

    .prefill-notice {
      font-size: 12px;
      color: var(--btc-orange);
      margin-top: 4px;
    }

    /* Location status indicator */
    .location-status {
      font-size: 13px;
      margin-top: 6px;
      padding: 8px 12px;
      border-radius: var(--radius);
      display: none;
    }

    .location-status.eligible {
      display: block;
      background: var(--success-bg);
      border: 1px solid var(--success-green);
      color: var(--success-green);
    }

    .location-status.cooldown {
      display: block;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error-red);
      color: var(--error-red);
    }

    .location-status.loading {
      display: block;
      color: var(--text-secondary);
    }

    .location-status.not-found {
      display: block;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error-red);
      color: var(--error-red);
    }

    /* Location header for check form */
    .location-header {
      background: linear-gradient(135deg, rgba(247, 147, 26, 0.15), rgba(247, 147, 26, 0.05));
      border: 1px solid rgba(247, 147, 26, 0.3);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }

    .location-header-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .location-header-name {
      font-size: 24px;
      font-weight: 600;
      color: var(--btc-orange);
      margin-bottom: 4px;
    }

    .location-header-id {
      font-size: 13px;
      color: var(--text-muted);
      font-family: monospace;
    }

    .location-header .location-status {
      margin-top: 12px;
    }

    /* No location selected message */
    .no-location-message {
      text-align: center;
      padding: 48px 24px;
    }

    .no-location-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .no-location-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .no-location-text {
      color: var(--text-secondary);
      margin-bottom: 24px;
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
    }

    .btn-primary {
      display: inline-block;
      background: var(--btc-orange);
      color: #000;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: var(--radius);
      text-decoration: none;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: var(--btc-orange-dark);
      color: #000;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .form-card {
        padding: 16px;
      }

      .form-tabs {
        flex-direction: column;
      }

      .location-header-name {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="header-content">
    <h1>
      <span class="btc-icon">‚Çø</span>
      Satoshis f√ºr Berlin
    </h1>
    <a href="./" class="btn">‚Üê Zur √úbersicht</a>
  </div>
</header>

<main class="main">
  <div class="form-card">
    <div class="form-tabs">
      <div class="form-tab active" data-form="check">Check einreichen</div>
      <div class="form-tab" data-form="new-location">Neuen Ort melden</div>
    </div>

    <!-- CHECK FORM -->
    <form id="check-form" class="form-section active">
      <!-- Location header - shown when location_id is provided via URL -->
      <div id="location-header" class="location-header" style="display: none;">
        <div class="location-header-label">Check einreichen f√ºr:</div>
        <div class="location-header-name" id="location-name-display">Wird geladen...</div>
        <div class="location-header-id" id="location-id-display"></div>
        <div id="location-status" class="location-status"></div>
        <input type="hidden" name="location_id" id="location-id-input">
        <input type="hidden" name="location_name" id="location-name-input">
      </div>

      <!-- No location selected message - shown when no location_id in URL -->
      <div id="no-location-message" class="no-location-message">
        <div class="no-location-icon">üìç</div>
        <div class="no-location-title">Kein Ort ausgew√§hlt</div>
        <div class="no-location-text">
          Bitte w√§hle zuerst einen Ort aus der √úbersicht, f√ºr den du einen Check einreichen m√∂chtest.
        </div>
        <a href="./" class="btn btn-primary">‚Üí Zur √úbersicht</a>
      </div>

      <!-- Rest of form - hidden until location is selected -->
      <div id="check-form-fields" style="display: none;">
      <div class="section-title">Zeitpunkt</div>

      <div class="field">
        <label>Datum und Uhrzeit des Kaufs <span class="required">*</span></label>
        <div class="field-hint">Wann hast du bezahlt?</div>
        <input type="datetime-local" name="date_time" required>
      </div>

      <div class="field">
        <label>Art des Checks <span class="required">*</span></label>
        <select name="check_type" id="check-type-select" required>
          <option value="">‚Äì Bitte w√§hlen ‚Äì</option>
          <option value="normal">Normaler Check ‚Äì Ort akzeptiert weiterhin Bitcoin</option>
          <option value="critical">Kritische √Ñnderung ‚Äì Ort nimmt kein Bitcoin mehr / geschlossen / umgezogen</option>
        </select>
      </div>

      <div class="section-title">Nachweise</div>

      <!-- Fields for normal checks only -->
      <div id="normal-check-fields">
        <div class="field">
          <label>1. √ñffentlicher Post <span class="required">*</span></label>
          <div class="field-hint">Link zu deinem Post mit "Berlin" und "Bitcoin"</div>
          <input type="url" name="public_post_url" placeholder="https://x.com/deinname/status/..." required>
        </div>

        <div class="field">
          <label>2. Kaufnachweis <span class="required">*</span></label>
          <div class="field-hint">Bon, POS-Display, Handy-Screenshot oder √§hnliches. Hochladen bei <a href="https://catbox.moe/" target="_blank">Catbox</a>, <a href="https://pic.infini.fr/" target="_blank">Lutim</a> oder <a href="https://imgbb.com/" target="_blank">Imgbb</a> ‚Äì pers√∂nliche Daten schw√§rzen!</div>
          <input type="url" name="receipt_proof_url" placeholder="https://files.catbox.moe/..." required>
        </div>

        <div class="field">
          <label>3. Bitcoin-Zahlung <span class="required">*</span></label>
          <div class="field-hint">Screenshot mit Best√§tigung "bezahlt"</div>
          <input type="url" name="payment_proof_url" placeholder="https://files.catbox.moe/..." required>
        </div>

        <div class="field">
          <label>4. Foto vom Ort <span class="required">*</span></label>
          <div class="field-hint">Schild, Eingang oder Kasse</div>
          <input type="url" name="venue_photo_url" placeholder="https://files.catbox.moe/..." required>
        </div>
      </div>

      <!-- Fields for critical changes only -->
      <div id="critical-check-fields" style="display: none;">
        <div class="field">
          <label>Beweis-Foto <span class="required">*</span></label>
          <div class="field-hint">Foto vom Ort: entferntes Bitcoin-Schild, "Kein Bitcoin"-Hinweis, geschlossener Laden, etc. Hochladen bei <a href="https://catbox.moe/" target="_blank">Catbox</a>, <a href="https://pic.infini.fr/" target="_blank">Lutim</a> oder <a href="https://imgbb.com/" target="_blank">Imgbb</a></div>
          <input type="url" name="critical_evidence_url" placeholder="https://files.catbox.moe/...">
        </div>

        <div class="field">
          <label>√ñffentlicher Post (optional)</label>
          <div class="field-hint">Falls du √ºber die √Ñnderung gepostet hast</div>
          <input type="url" name="critical_post_url" placeholder="https://x.com/deinname/status/...">
        </div>
      </div>

      <div class="section-title">Zus√§tzliche Infos</div>

      <div class="field" id="observations-field">
        <label id="observations-label">Wie lief die Zahlung? <span class="required">*</span></label>
        <textarea name="observations" id="observations-input" placeholder="Zahlung per Lightning an der Kasse, hat sofort funktioniert..." required></textarea>
      </div>

      <div class="field" id="suggested-updates-field">
        <label id="suggested-updates-label">√Ñnderungen am Eintrag n√∂tig?</label>
        <div class="field-hint" id="suggested-updates-hint">Optional: Falls du Fehler bemerkt hast</div>
        <textarea name="suggested_updates" id="suggested-updates-input" placeholder="√ñffnungszeiten stimmen nicht: Laut Aushang Mo-Fr 10-19 Uhr"></textarea>
      </div>

      <div class="privacy-notice">
        <strong>üîí Auszahlung (privat)</strong><br>
        Die folgenden Angaben werden <strong>NICHT</strong> √∂ffentlich gepostet. Sie dienen nur zur Auszahlung deines Bounties.<br><br>
        <strong>Tipp:</strong> Verwende bei jedem Check dieselbe Kontaktadresse, um vom <a href="https://github.com/satoshiinberlin/sats4berlin/blob/main/README.md#aktivit%C3%A4tsfaktor-bis-20" target="_blank">Aktivit√§tsfaktor</a> (bis zu 2√ó Bounty) zu profitieren!
      </div>

      <div class="field">
        <label>Auszahlungsmethode <span class="required">*</span></label>
        <select name="contact_method" id="check-contact-method" required>
          <option value="">‚Äì Bitte w√§hlen ‚Äì</option>
          <option value="lightning">Lightning-Adresse (direkter Empfang)</option>
          <option value="nostr">Nostr (verschl√ºsselte DM mit Cashu-Token)</option>
          <option value="email">E-Mail (Cashu-Token per Mail)</option>
          <option value="telegram">Telegram (Cashu-Token per DM)</option>
          <option value="simplex">SimpleX Chat (Cashu-Token)</option>
        </select>
      </div>

      <div class="field">
        <label>Deine Kontaktadresse <span class="required">*</span></label>
        <div class="field-hint" id="check-contact-hint">Gib deine Adresse f√ºr die gew√§hlte Methode ein</div>
        <input type="text" name="contact_value" id="check-contact-value" placeholder="satoshi@getalby.com" required>
      </div>

      <button type="submit">Check einreichen</button>

      <div id="check-status" class="status-message"></div>
      </div><!-- /check-form-fields -->
    </form>

    <!-- NEW LOCATION FORM -->
    <form id="new-location-form" class="form-section">
      <div class="section-title">Angaben zum Ort</div>

      <div class="field">
        <label>Name des Ortes <span class="required">*</span></label>
        <input type="text" name="name" placeholder="Caf√© Beispiel" required>
      </div>

      <div class="field">
        <label>Adresse <span class="required">*</span></label>
        <div class="field-hint">Vollst√§ndige Adresse mit PLZ</div>
        <input type="text" name="address" placeholder="Musterstra√üe 1, 10115 Berlin" required>
      </div>

      <div class="field">
        <label>Kategorie <span class="required">*</span></label>
        <select name="category" required>
          <option value="">‚Äì Bitte w√§hlen ‚Äì</option>
          <option value="restaurant">Restaurant / Caf√© / Bar</option>
          <option value="shop">Einzelhandel / Shop</option>
          <option value="service">Dienstleistung</option>
          <option value="hotel">Hotel / Unterkunft</option>
          <option value="other">Sonstiges</option>
        </select>
      </div>

      <div class="field">
        <label>Website</label>
        <input type="url" name="website" placeholder="https://www.beispiel.de">
      </div>

      <div class="field">
        <label>OpenStreetMap-Link</label>
        <div class="field-hint">Falls der Ort bereits in OSM existiert</div>
        <input type="url" name="osm_url" placeholder="https://www.openstreetmap.org/node/...">
      </div>

      <div class="section-title">Dein Kauf vor Ort</div>

      <div class="field">
        <label>Datum und Uhrzeit des Kaufs <span class="required">*</span></label>
        <input type="datetime-local" name="date_time" required>
      </div>

      <div class="section-title">Nachweise</div>

      <div class="field">
        <label>1. √ñffentlicher Post <span class="required">*</span></label>
        <div class="field-hint">Link zu deinem Post mit "Berlin" und "Bitcoin"</div>
        <input type="url" name="public_post_url" placeholder="https://x.com/deinname/status/..." required>
      </div>

      <div class="field">
        <label>2. Kaufnachweis <span class="required">*</span></label>
        <div class="field-hint">Bon, POS-Display, Handy-Screenshot oder √§hnliches. Hochladen bei <a href="https://catbox.moe/" target="_blank">Catbox</a>, <a href="https://pic.infini.fr/" target="_blank">Lutim</a> oder <a href="https://imgbb.com/" target="_blank">Imgbb</a> ‚Äì pers√∂nliche Daten schw√§rzen!</div>
        <input type="url" name="receipt_proof_url" placeholder="https://files.catbox.moe/..." required>
      </div>

      <div class="field">
        <label>3. Bitcoin-Zahlung <span class="required">*</span></label>
        <div class="field-hint">Screenshot mit Best√§tigung "bezahlt"</div>
        <input type="url" name="payment_proof_url" placeholder="https://files.catbox.moe/..." required>
      </div>

      <div class="field">
        <label>4. Foto vom Ort <span class="required">*</span></label>
        <div class="field-hint">Schild, Eingang oder Kasse</div>
        <input type="url" name="venue_photo_url" placeholder="https://files.catbox.moe/..." required>
      </div>

      <div class="section-title">Zus√§tzliche Infos</div>

      <div class="field">
        <label>Wie lief die Zahlung? <span class="required">*</span></label>
        <div class="field-hint">Beschreibe deine Erfahrung, nenne √ñffnungszeiten falls bekannt</div>
        <textarea name="notes" placeholder="Zahlung per Lightning an der Kasse, hat sofort funktioniert. √ñffnungszeiten laut Aushang: Mo-Fr 10-18 Uhr" required></textarea>
      </div>

      <div class="privacy-notice">
        <strong>üîí Auszahlung (privat)</strong><br>
        Die folgenden Angaben werden <strong>NICHT</strong> √∂ffentlich gepostet.<br><br>
        <strong>Hinweis:</strong> Bei Neueintr√§gen erfolgt die Auszahlung erst nach Best√§tigung durch 2 weitere Bitcoiner (insgesamt 3 Checks).<br><br>
        <strong>Tipp:</strong> Verwende bei jedem Check dieselbe Kontaktadresse, um vom Aktivit√§tsfaktor (bis zu 2√ó Bounty) zu profitieren!
      </div>

      <div class="field">
        <label>Auszahlungsmethode <span class="required">*</span></label>
        <select name="contact_method" id="newloc-contact-method" required>
          <option value="">‚Äì Bitte w√§hlen ‚Äì</option>
          <option value="lightning">Lightning-Adresse (direkter Empfang)</option>
          <option value="nostr">Nostr (verschl√ºsselte DM mit Cashu-Token)</option>
          <option value="email">E-Mail (Cashu-Token per Mail)</option>
          <option value="telegram">Telegram (Cashu-Token per DM)</option>
          <option value="simplex">SimpleX Chat (Cashu-Token)</option>
        </select>
      </div>

      <div class="field">
        <label>Deine Kontaktadresse <span class="required">*</span></label>
        <div class="field-hint" id="newloc-contact-hint">Gib deine Adresse f√ºr die gew√§hlte Methode ein</div>
        <input type="text" name="contact_value" id="newloc-contact-value" placeholder="satoshi@getalby.com" required>
      </div>

      <button type="submit">Neuen Ort melden</button>

      <div id="new-location-status" class="status-message"></div>
    </form>
  </div>
</main>

<!-- Result Modal -->
<div id="result-modal" class="modal-overlay">
  <div id="modal-content" class="modal-content">
    <button class="modal-close" id="modal-close">&times;</button>
    <div id="modal-icon" class="modal-icon"></div>
    <img id="modal-gif" class="modal-gif" style="display: none;" alt="Celebration">
    <div id="modal-title" class="modal-title"></div>
    <div id="modal-body" class="modal-body"></div>
    <button id="modal-btn" class="modal-btn">Schlie√üen</button>
  </div>
</div>

<footer class="footer">
  <a href="./">‚Üê Zur√ºck zur √úbersicht</a>
</footer>

<script>
  const WORKER_URL = 'https://sats4berlin-form-handler.satoshiinberlin.workers.dev/api/submit';

  // Tab switching
  document.querySelectorAll('.form-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));

      tab.classList.add('active');
      const formId = tab.dataset.form === 'check' ? 'check-form' : 'new-location-form';
      document.getElementById(formId).classList.add('active');
    });
  });

  // Switch to new-location tab if ?form=new-location is in URL
  const formParam = new URLSearchParams(window.location.search).get('form');
  if (formParam === 'new-location') {
    document.querySelectorAll('.form-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
    document.querySelector('.form-tab[data-form="new-location"]').classList.add('active');
    document.getElementById('new-location-form').classList.add('active');
  }

  // Form submission
  async function submitForm(form, statusEl) {
    const formData = new FormData(form);
    const data = {};

    formData.forEach((value, key) => {
      if (value.trim()) {
        data[key] = value.trim();
      }
    });

    statusEl.className = 'status-message';
    statusEl.style.display = 'none';

    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Wird gesendet...';

    try {
      const response = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data })
      });

      const result = await response.json();

      if (result.success) {
        // Validate issueUrl is a valid GitHub URL to prevent XSS
        const issueUrl = result.issueUrl || '';
        const isValidGitHubUrl = /^https:\/\/github\.com\/[\w-]+\/[\w-]+\/issues\/\d+$/.test(issueUrl);

        // Show success modal
        const celebrationGifs = [
          'https://media.giphy.com/media/lQh95VIYba5yba2H08/giphy.gif',
          'https://media.giphy.com/media/trN9ht5RlE3Dcwavg2/giphy.gif',
          'https://media.giphy.com/media/YkYt0FzMNPJkFnSCxJ/giphy.gif',
          'https://media.giphy.com/media/artj92V8o75VPL7AeQ/giphy.gif',
          'https://media.giphy.com/media/l0MYGb1LuZ3n7dRnO/giphy.gif',
          'https://media.giphy.com/media/3o6fJ1BM7R2EBRDnxK/giphy.gif',
        ];

        let bodyHtml = 'Dein Check wurde erstellt.<br><br>';
        if (isValidGitHubUrl) {
          bodyHtml += `<a href="${issueUrl}" target="_blank" rel="noopener">${issueUrl}</a><br><br>`;
        }
        bodyHtml += 'Speichere den Link ‚Äì dort siehst du den Status deines Checks.';

        showModal({
          type: 'success',
          title: 'Erfolgreich eingereicht!',
          body: bodyHtml,
          gifUrl: celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)]
        });

        form.reset();
      } else {
        throw new Error(result.error || 'Unbekannter Fehler');
      }
    } catch (error) {
      // Translate common error messages to German
      let errorMessage = error.message || 'Unbekannter Fehler';
      let helpText = 'Bitte versuche es erneut.';

      if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
        errorMessage = 'Netzwerkfehler';
        helpText = 'Bitte pr√ºfe deine Internetverbindung und versuche es erneut.';
      } else if (error.message === 'Invalid origin') {
        errorMessage = 'Ung√ºltige Anfrage';
        helpText = 'Bitte lade die Seite neu und versuche es erneut.';
      } else if (error.message === 'Rate limit exceeded' || error.message?.includes('Rate limit')) {
        errorMessage = 'Zu viele Anfragen';
        helpText = 'Bitte warte eine Stunde, bevor du erneut einreichst.';
      } else if (error.message?.includes('Invalid location ID')) {
        errorMessage = 'Ung√ºltige Location-ID';
        helpText = 'Bitte pr√ºfe die Location-ID (Format: DE-BE-00042).';
      } else if (error.message?.includes('Date cannot be in the future')) {
        errorMessage = 'Ung√ºltiges Datum';
        helpText = 'Das Kaufdatum darf nicht in der Zukunft liegen.';
      } else if (error.message?.includes('Invalid URL')) {
        errorMessage = 'Ung√ºltige URL';
        helpText = 'Bitte pr√ºfe, ob alle Links korrekt eingegeben wurden.';
      }

      showModal({
        type: 'error',
        title: errorMessage,
        body: helpText
      });
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  }

  // Modal functions
  function showModal({ type, title, body, gifUrl }) {
    const modal = document.getElementById('result-modal');
    const content = document.getElementById('modal-content');
    const iconEl = document.getElementById('modal-icon');
    const gifEl = document.getElementById('modal-gif');
    const titleEl = document.getElementById('modal-title');
    const bodyEl = document.getElementById('modal-body');

    content.className = 'modal-content ' + type;
    iconEl.textContent = type === 'success' ? '' : '‚ö†Ô∏è';
    iconEl.style.display = type === 'success' && gifUrl ? 'none' : 'block';

    if (type === 'success' && gifUrl) {
      gifEl.src = gifUrl;
      gifEl.style.display = 'block';
    } else {
      gifEl.style.display = 'none';
    }

    titleEl.textContent = title;
    bodyEl.innerHTML = body;

    modal.classList.add('visible');
  }

  function hideModal() {
    document.getElementById('result-modal').classList.remove('visible');
  }

  document.getElementById('modal-close').addEventListener('click', hideModal);
  document.getElementById('modal-btn').addEventListener('click', hideModal);
  document.getElementById('result-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) hideModal();
  });

  document.getElementById('check-form').addEventListener('submit', (e) => {
    e.preventDefault();
    submitForm(e.target, document.getElementById('check-status'));
  });

  document.getElementById('new-location-form').addEventListener('submit', (e) => {
    e.preventDefault();
    submitForm(e.target, document.getElementById('new-location-status'));
  });

  // Handle location_id from URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const locationId = urlParams.get('location_id');

  const locationHeader = document.getElementById('location-header');
  const noLocationMessage = document.getElementById('no-location-message');
  const checkFormFields = document.getElementById('check-form-fields');
  const locationIdInput = document.getElementById('location-id-input');
  const locationNameInput = document.getElementById('location-name-input');
  const locationNameDisplay = document.getElementById('location-name-display');
  const locationIdDisplay = document.getElementById('location-id-display');

  if (locationId && /^DE-BE-\d{5}$/.test(locationId)) {
    // Valid location_id provided - show form
    locationIdInput.value = locationId;
    locationIdDisplay.textContent = locationId;
    locationHeader.style.display = 'block';
    noLocationMessage.style.display = 'none';
    checkFormFields.style.display = 'block';

    // Load location name from CSV
    if (typeof Papa !== 'undefined') {
      Papa.parse('data/locations.csv', {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const loc = results.data.find(r => (r.location_id || '').trim() === locationId);
          if (loc && loc.name) {
            locationNameDisplay.textContent = loc.name;
            locationNameInput.value = loc.name;
          } else {
            locationNameDisplay.textContent = locationId;
            locationNameInput.value = '';
          }
        },
        error: () => {
          locationNameDisplay.textContent = locationId;
          locationNameInput.value = '';
        }
      });
    } else {
      locationNameDisplay.textContent = locationId;
      locationNameInput.value = '';
    }
  } else {
    // No valid location_id - show message to select from table
    locationHeader.style.display = 'none';
    noLocationMessage.style.display = 'block';
    checkFormFields.style.display = 'none';
  }

  // Contact method hints and placeholders
  const contactConfig = {
    lightning: {
      hint: 'Deine Lightning-Adresse f√ºr direkten Empfang',
      placeholder: 'satoshi@getalby.com'
    },
    nostr: {
      hint: 'Dein Nostr Public Key (npub) f√ºr verschl√ºsselte DM',
      placeholder: 'npub1...'
    },
    email: {
      hint: 'Deine E-Mail-Adresse f√ºr Cashu-Token',
      placeholder: 'satoshi@example.com'
    },
    telegram: {
      hint: 'Dein Telegram-Username (mit @)',
      placeholder: '@satoshi'
    },
    simplex: {
      hint: 'Dein SimpleX-Einladungslink oder Kontaktadresse',
      placeholder: 'https://simplex.chat/contact#...'
    }
  };

  function updateContactFields(selectId, hintId, inputId) {
    const select = document.getElementById(selectId);
    const hint = document.getElementById(hintId);
    const input = document.getElementById(inputId);

    select.addEventListener('change', () => {
      const method = select.value;
      if (method && contactConfig[method]) {
        hint.textContent = contactConfig[method].hint;
        input.placeholder = contactConfig[method].placeholder;
      } else {
        hint.textContent = 'Gib deine Adresse f√ºr die gew√§hlte Methode ein';
        input.placeholder = '';
      }
    });
  }

  updateContactFields('check-contact-method', 'check-contact-hint', 'check-contact-value');
  updateContactFields('newloc-contact-method', 'newloc-contact-hint', 'newloc-contact-value');

  // Set max date/time to now for all datetime-local inputs
  function setDateTimeConstraints() {
    const now = new Date();
    // Use local time (not UTC) since datetime-local inputs work in local timezone
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const maxDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;

    document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
      input.max = maxDateTime;
    });
  }

  setDateTimeConstraints();

  // Location status checker - shows if location is eligible or in cooldown
  // Wrapped in try-catch to prevent breaking form submission if PapaParse fails
  try {
    if (typeof Papa !== 'undefined') {
      let locationCache = null;
      let locationCacheTime = 0;
      const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

      function loadLocations() {
        return new Promise((resolve) => {
          const now = Date.now();
          if (locationCache && (now - locationCacheTime) < CACHE_TTL) {
            resolve(locationCache);
            return;
          }

          Papa.parse('data/locations.csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              const locations = {};
              for (const row of results.data) {
                const id = (row.location_id || '').trim();
                if (id) {
                  locations[id] = {
                    name: (row.name || '').trim(),
                    eligible: (row.eligible_now || '').toLowerCase() === 'yes',
                    cooldownDays: parseInt(row.cooldown_days_left || '0', 10)
                  };
                }
              }
              locationCache = locations;
              locationCacheTime = now;
              resolve(locations);
            },
            error: (err) => {
              console.error('Failed to load locations:', err);
              resolve({});
            }
          });
        });
      }

      async function checkLocationStatus(locId) {
        const statusEl = document.getElementById('location-status');
        if (!statusEl) return;

        if (!locId || !/^DE-BE-\d{5}$/.test(locId)) {
          statusEl.className = 'location-status';
          statusEl.textContent = '';
          return;
        }

        statusEl.className = 'location-status loading';
        statusEl.textContent = 'Pr√ºfe Status...';

        const locations = await loadLocations();
        const loc = locations[locId];

        if (!loc) {
          statusEl.className = 'location-status not-found';
          statusEl.textContent = '‚ö† Location-ID nicht gefunden. Bitte pr√ºfe die ID in der √úbersicht.';
          return;
        }

        if (loc.eligible) {
          statusEl.className = 'location-status eligible';
          statusEl.textContent = '‚úì Auszahlbar! Du kannst einen Check einreichen.';
        } else {
          statusEl.className = 'location-status cooldown';
          statusEl.textContent = `‚ö† Noch ${loc.cooldownDays} Tage im Cooldown. Ein Check ist derzeit nicht auszahlbar.`;
        }
      }

      // Check location status on page load
      if (locationId && /^DE-BE-\d{5}$/.test(locationId)) {
        checkLocationStatus(locationId);
      }
    }
  } catch (e) {
    console.error('Location status checker failed to initialize:', e);
  }

  // Check type toggle - show different fields for normal vs critical checks
  // Wrapped in try-catch to prevent breaking form submission if something goes wrong
  try {
    const checkTypeSelect = document.getElementById('check-type-select');
    const normalFields = document.getElementById('normal-check-fields');
    const criticalFields = document.getElementById('critical-check-fields');
    const observationsLabel = document.getElementById('observations-label');
    const observationsInput = document.getElementById('observations-input');
    const suggestedUpdatesLabel = document.getElementById('suggested-updates-label');
    const suggestedUpdatesHint = document.getElementById('suggested-updates-hint');
    const suggestedUpdatesInput = document.getElementById('suggested-updates-input');

    if (checkTypeSelect && normalFields && criticalFields) {
      checkTypeSelect.addEventListener('change', () => {
        const isCritical = checkTypeSelect.value === 'critical';

        if (isCritical) {
          // Show critical fields, hide normal fields
          normalFields.style.display = 'none';
          criticalFields.style.display = 'block';

          // Remove required from normal fields
          normalFields.querySelectorAll('input[required]').forEach(input => {
            input.removeAttribute('required');
            input.dataset.wasRequired = 'true';
          });

          // Add required to critical evidence field
          const evidenceInput = criticalFields.querySelector('input[name="critical_evidence_url"]');
          if (evidenceInput) evidenceInput.required = true;

          // Update observations label and placeholder
          if (observationsLabel) observationsLabel.innerHTML = 'Was ist passiert? <span class="required">*</span>';
          if (observationsInput) observationsInput.placeholder = 'Wollte mit Bitcoin zahlen, aber Mitarbeiter sagte, sie akzeptieren das nicht mehr...';

          // Update suggested updates for critical (moved location scenario)
          if (suggestedUpdatesLabel) suggestedUpdatesLabel.textContent = 'Neue Adresse (falls umgezogen)';
          if (suggestedUpdatesHint) suggestedUpdatesHint.textContent = 'Optional: Falls der Ort an eine neue Adresse umgezogen ist';
          if (suggestedUpdatesInput) suggestedUpdatesInput.placeholder = 'Neue Adresse: Musterstra√üe 123, 10115 Berlin';
        } else {
          // Show normal fields, hide critical fields
          normalFields.style.display = 'block';
          criticalFields.style.display = 'none';

          // Restore required on normal fields
          normalFields.querySelectorAll('input[data-was-required="true"]').forEach(input => {
            input.required = true;
          });

          // Remove required from critical evidence field
          const evidenceInput = criticalFields.querySelector('input[name="critical_evidence_url"]');
          if (evidenceInput) evidenceInput.required = false;

          // Restore observations label and placeholder
          if (observationsLabel) observationsLabel.innerHTML = 'Wie lief die Zahlung? <span class="required">*</span>';
          if (observationsInput) observationsInput.placeholder = 'Zahlung per Lightning an der Kasse, hat sofort funktioniert...';

          // Restore suggested updates for normal checks
          if (suggestedUpdatesLabel) suggestedUpdatesLabel.textContent = '√Ñnderungen am Eintrag n√∂tig?';
          if (suggestedUpdatesHint) suggestedUpdatesHint.textContent = 'Optional: Falls du Fehler bemerkt hast';
          if (suggestedUpdatesInput) suggestedUpdatesInput.placeholder = '√ñffnungszeiten stimmen nicht: Laut Aushang Mo-Fr 10-19 Uhr';
        }
      });
    }
  } catch (e) {
    console.error('Check type toggle failed to initialize:', e);
  }
</script>

</body>
</html>
