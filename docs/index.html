<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Satoshis für Berlin – die Millionenchallenge</title>

  <!-- Robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --b:#eee; --t:#111; --m:#555; --bg:#fff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; line-height: 1.35; color:var(--t); background:var(--bg); }
    h1 { margin: 0 0 6px 0; font-size: 22px; }
    .sub { color:var(--m); margin: 0 0 14px 0; }
    .pill { display:inline-block; padding:3px 10px; border:1px solid var(--b); border-radius:999px; margin-right:8px; }
    .grid { display:grid; gap:10px; grid-template-columns: 1fr; }
    @media(min-width: 900px){ .grid { grid-template-columns: 2fr 1fr; } }

    input, select { width:100%; padding:10px; font-size: 15px; border:1px solid var(--b); border-radius:10px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { display:inline-block; padding:9px 12px; border:1px solid var(--b); border-radius:10px; text-decoration:none; color:inherit; background:#fafafa; }
    .btn:hover { background:#f4f4f4; }
    .small { font-size: 13px; color:var(--m); }

    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid var(--b); padding: 8px; vertical-align: top; }
    th { position: sticky; top: 0; background: #fff; z-index: 1; text-align:left; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .nowrap { white-space: nowrap; }

    /* Sortable column headers */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background: #f5f5f5; }
    th.sortable::after { content: " \2195"; color: #ccc; font-size: 12px; }
    th.sortable.asc::after { content: " \2191"; color: var(--t); }
    th.sortable.desc::after { content: " \2193"; color: var(--t); }

    .toast { position: fixed; bottom: 14px; left: 14px; padding: 10px 12px; border:1px solid var(--b); border-radius:12px; background:#fff; box-shadow: 0 10px 30px rgba(0,0,0,.08); display:none; }
  </style>
</head>

<body>
  <h1>Satoshis für Berlin – die Millionenchallenge</h1>
  <p class="sub">
    <span class="pill"><strong>1.000.000 sats</strong> Gesamtbounty</span>
    <span class="pill">Basis: BTCMap/OSM</span>
    <span class="pill">Nur Kauf vor Ort in Bitcoin</span>
  </p>

  <div class="row">
    <a class="btn" id="btnSubmit" href="#" target="_blank" rel="noopener">Check einreichen</a>
    <a class="btn" id="btnRules" href="#" target="_blank" rel="noopener">Regeln</a>
    <a class="btn" id="btnCSV" href="data/locations.csv" target="_blank" rel="noopener">locations.csv</a>
    <a class="btn" id="btnChecks" href="data/checks_public.csv" target="_blank" rel="noopener">checks_public.csv</a>
    <span class="small" id="meta">Lade Daten…</span>
  </div>

  <div class="grid" style="margin-top:12px;">
    <input id="q" placeholder="Suche (Name, Kategorie, Adresse, PLZ)…" />
    <select id="eligible">
      <option value="">Bounty: alle</option>
      <option value="yes">Bounty: jetzt möglich</option>
      <option value="no">Bounty: im Cooldown</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th class="sortable" data-sort="name">Name</th>
        <th class="sortable" data-sort="address">Adresse</th>
        <th class="sortable nowrap" data-sort="bounty">Bounty</th>
        <th class="sortable nowrap" data-sort="last_check">Letzter Check</th>
        <th class="sortable nowrap" data-sort="cooldown">Cooldown bis</th>
        <th class="nowrap">Location-ID</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
  </table>

  <div class="toast" id="toast"></div>

<script>
  // === CONFIG: passe das an ===
  const REPO_URL = "https://github.com/satoshiinberlin/sats4berlin";
  // ============================

  // Set buttons to repo resources
  document.getElementById("btnSubmit").href = `${REPO_URL}/issues/new/choose`;
  document.getElementById("btnRules").href  = `${REPO_URL}/blob/main/RULES.md`;

  const toast = (msg) => {
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>{ el.style.display="none"; }, 1800);
  };

  const norm = (s) => (s ?? "").toString().trim();
  const toInt = (s) => {
    const n = parseInt((s ?? "").toString().replace(/[^\d]/g,""), 10);
    return Number.isFinite(n) ? n : 0;
  };

  let rows = [];
  let sortColumn = "bounty";
  let sortDirection = "desc";

  function addr(r){
    return [r.street, r.housenumber, r.postcode, r.city].map(norm).filter(Boolean).join(" ");
  }

  function updateSortIndicators() {
    document.querySelectorAll("th.sortable").forEach(th => {
      th.classList.remove("asc", "desc");
      if (th.dataset.sort === sortColumn) {
        th.classList.add(sortDirection);
      }
    });
  }

  function render() {
    const q = norm(document.getElementById("q").value).toLowerCase();
    const el = norm(document.getElementById("eligible").value).toLowerCase();

    let view = rows.filter(r => {
      const hay = [
        r.name, r.category, r.street, r.housenumber, r.postcode, r.city
      ].map(x => norm(x).toLowerCase()).join(" ");
      if (q && !hay.includes(q)) return false;
      if (el && norm(r.eligible_now).toLowerCase() !== el) return false;
      return true;
    });

    // Sort comparators
    const comparators = {
      name: (a, b) => norm(a.name).localeCompare(norm(b.name)),
      address: (a, b) => addr(a).localeCompare(addr(b)),
      bounty: (a, b) => toInt(a.bounty_base_sats) - toInt(b.bounty_base_sats),
      last_check: (a, b) => norm(a.source_last_update).localeCompare(norm(b.source_last_update)),
      cooldown: (a, b) => norm(a.cooldown_until).localeCompare(norm(b.cooldown_until)),
    };

    const cmp = comparators[sortColumn] || comparators.bounty;
    view.sort((a, b) => {
      const result = cmp(a, b);
      return sortDirection === "desc" ? -result : result;
    });

    updateSortIndicators();

    document.getElementById("meta").textContent =
      `Treffer: ${view.length} / ${rows.length}`;

    const body = document.getElementById("body");
    body.innerHTML = view.map(r => {
      const link = norm(r.btcmap_url) || (norm(r.osm_type) && norm(r.osm_id) ? `https://www.openstreetmap.org/${r.osm_type}/${r.osm_id}` : "");
      const bounty = `${toInt(r.bounty_base_sats).toLocaleString("de-DE")} sats`;
      const lid = norm(r.location_id);
      return `
        <tr>
          <td>
            <strong>${norm(r.name) || "—"}</strong><br>
            <span class="small">${norm(r.category) || "—"}</span>
          </td>
          <td>${addr(r) || "—"}</td>
          <td class="nowrap">${bounty}<br><span class="small">eligible: ${norm(r.eligible_now) || "—"}</span></td>
          <td class="nowrap">${norm(r.source_last_update) || "—"}</td>
          <td class="nowrap">${norm(r.cooldown_until) || "—"}</td>
          <td class="mono nowrap">
            <button class="btn" style="padding:6px 8px;" data-copy="${lid}">Copy</button>
            <div style="margin-top:6px;">${lid}</div>
          </td>
          <td class="nowrap">${link ? `<a href="${link}" target="_blank" rel="noopener">OSM/BTCMap</a>` : "—"}</td>
        </tr>
      `;
    }).join("");

    // Copy handlers
    body.querySelectorAll("button[data-copy]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const v = btn.getAttribute("data-copy");
        try { await navigator.clipboard.writeText(v); toast(`Kopiert: ${v}`); }
        catch { toast("Copy nicht möglich (Browser)"); }
      });
    });
  }

  function load() {
    const meta = document.getElementById("meta");
    meta.textContent = "Lade locations.csv…";

    Papa.parse("data/locations.csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      dynamicTyping: false,
      complete: (res) => {
        rows = (res.data || []).filter(r => r && r.location_id);
        meta.textContent = `Geladen: ${rows.length} Einträge`;
        render();
      },
      error: (err) => {
        meta.innerHTML = `<span class="bad">Fehler beim Laden: ${err}</span>`;
      }
    });
  }

  // Filter event listeners
  ["q","eligible"].forEach(id=>{
    document.getElementById(id).addEventListener("input", render);
    document.getElementById(id).addEventListener("change", render);
  });

  // Column header click handlers for sorting
  document.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", () => {
      const col = th.dataset.sort;
      if (sortColumn === col) {
        // Toggle direction
        sortDirection = sortDirection === "asc" ? "desc" : "asc";
      } else {
        // New column, default to descending for bounty/dates, ascending for text
        sortColumn = col;
        sortDirection = (col === "bounty" || col === "last_check" || col === "cooldown") ? "desc" : "asc";
      }
      render();
    });
  });

  load();
</script>
</body>
</html>
