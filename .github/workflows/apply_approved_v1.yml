name: Apply approved issues to CSV (v1)

on:
  workflow_dispatch:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  apply:
    runs-on: ubuntu-latest
    # Run on manual trigger OR when "approved" label is added
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.label.name == 'approved')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install GitHub CLI (gh)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Fetch approved issues (raw JSON)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p data
          gh api -H "Accept: application/vnd.github+json" \
            "/repos/${GITHUB_REPOSITORY}/issues?state=all&labels=approved&per_page=100" \
            > data/_approved_issues.json
          echo "Saved approved issues to data/_approved_issues.json"
          head -c 200 data/_approved_issues.json || true
          echo ""

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Apply to CSV
        run: |
          python scripts/apply_approved_v1.py
          rm -f data/_approved_issues.json

      - name: Commit and push
        run: |
          git config user.name "sfb-bot"
          git config user.email "sfb-bot@users.noreply.github.com"
          git add data/locations.csv data/checks_public.csv
          git diff --cached --quiet || git commit -m "Apply approved issues (v1)"
          git push

      - name: Comment on approved issue
        if: github.event_name == 'issues' && github.event.label.name == 'approved'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get issue body and labels
          ISSUE_BODY=$(gh issue view ${{ github.event.issue.number }} --json body -q '.body')
          LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels -q '.labels[].name' | tr '\n' ' ')

          # Check if submission came via web form (has Submission ID)
          SUBMISSION_ID=$(echo "$ISSUE_BODY" | grep -oP 'Submission ID:\*\* `\K[^`]+' || echo "")

          # Extract Location-ID from issue body
          LOCATION_ID=$(echo "$ISSUE_BODY" | grep -oP 'Location-ID:\*\*\s*`\K[^`]+' || \
                        echo "$ISSUE_BODY" | grep -oP 'Location-ID\s*\n+\K[A-Z]{2}-[A-Z]{2}-\d+' || echo "")

          # Look up OSM info from locations.csv
          BTCMAP_LINK=""
          OSM_LINK=""
          if [ -n "$LOCATION_ID" ] && [ -f "data/locations.csv" ]; then
            OSM_INFO=$(grep "^$LOCATION_ID," data/locations.csv | head -1)
            if [ -n "$OSM_INFO" ]; then
              OSM_TYPE=$(echo "$OSM_INFO" | cut -d',' -f2)
              OSM_ID=$(echo "$OSM_INFO" | cut -d',' -f3)
              if [ -n "$OSM_TYPE" ] && [ -n "$OSM_ID" ]; then
                BTCMAP_LINK="https://btcmap.org/verify-location?id=${OSM_TYPE}:${OSM_ID}"
                OSM_LINK="https://www.openstreetmap.org/${OSM_TYPE}/${OSM_ID}"
              fi
            fi
          fi

          # Build BTCMap section for maintainer comment
          BTCMAP_SECTION=""
          if [ -n "$BTCMAP_LINK" ]; then
            ISSUE_URL="https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}"
            BTCMAP_SECTION="

          ---

          ### üó∫Ô∏è BTCMap aktualisieren

          Bitte aktualisiere BTCMap mit diesem Check:
          1. **[BTCMap Verification √∂ffnen](${BTCMAP_LINK})**
          2. Im Feld \"Additional notes\" diesen Issue-Link einf√ºgen: \`${ISSUE_URL}\`
          3. Formular absenden

          [OSM-Eintrag ansehen](${OSM_LINK})"
          fi

          if echo "$LABELS" | grep -q "new-location"; then
            # New location - payout held until confirmed
            gh issue comment ${{ github.event.issue.number }} --body "## ‚úÖ Check approved!

          Dein Check wurde gepr√ºft und **approved**.

          **Hinweis f√ºr Neueintr√§ge:** Die Auszahlung erfolgt erst, wenn **2 weitere Bitcoiner** den Ort durch einen eigenen Kauf best√§tigt haben (insgesamt 3 g√ºltige Checks).

          Sobald die Best√§tigungen vorliegen, erfolgt die Auszahlung automatisch an die von dir angegebene Adresse.
          ${BTCMAP_SECTION}

          ---
          *Automatische Nachricht von sats4berlin-bot*"
          elif [ -n "$SUBMISSION_ID" ]; then
            # Submitted via web form - contact info is stored privately
            gh issue comment ${{ github.event.issue.number }} --body "## ‚úÖ Check approved!

          Dein Check wurde gepr√ºft und **approved**. Vielen Dank!

          Die Auszahlung erfolgt in K√ºrze an die von dir im Formular angegebene Adresse.
          ${BTCMAP_SECTION}

          ---
          *Automatische Nachricht von sats4berlin-bot*"
          else
            # Submitted via GitHub form - need to request payout info
            gh issue comment ${{ github.event.issue.number }} --body "## ‚úÖ Check approved!

          Dein Check wurde gepr√ºft und **approved**. Vielen Dank!

          ### N√§chster Schritt: Auszahlungsziel mitteilen

          Bitte sende uns dein Auszahlungsziel **privat** per E-Mail oder Direktnachricht:
          - **Lightning-Adresse** (z.B. name@wallet.com)
          - oder **eCash-Token-Anfrage**

          ‚ö†Ô∏è **Wichtig:** Poste deine Lightning-Adresse **nicht** √∂ffentlich in diesem Issue!

          Kontakt f√ºr Auszahlung: satoshiinberlin@proton.me
          ${BTCMAP_SECTION}

          ---
          *Automatische Nachricht von sats4berlin-bot*"
          fi
