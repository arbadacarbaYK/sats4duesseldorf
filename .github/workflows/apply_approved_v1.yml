name: Apply approved issues to CSV (v1)

on:
  workflow_dispatch:
  issues:
    types: [labeled]

# Prevent concurrent CSV writes - wait for other workflows to finish
concurrency:
  group: csv-write
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:
  apply:
    runs-on: ubuntu-latest
    # Run on manual trigger OR when "approved" label is added
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.label.name == 'approved')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull latest changes (prevent race conditions)
        run: |
          git pull --rebase origin main || git pull origin main

      - name: Install GitHub CLI (gh)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Fetch approved issues (raw JSON)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p data
          gh api -H "Accept: application/vnd.github+json" \
            "/repos/${GITHUB_REPOSITORY}/issues?state=all&labels=approved&per_page=100" \
            > data/_approved_issues.json
          echo "Saved approved issues to data/_approved_issues.json"
          head -c 200 data/_approved_issues.json || true
          echo ""

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Apply to CSV
        run: |
          python scripts/apply_approved_v1.py
          rm -f data/_approved_issues.json

      - name: Copy to docs/data for GitHub Pages
        run: |
          mkdir -p docs/data
          cp -f data/locations.csv docs/data/locations.csv
          cp -f data/checks_public.csv docs/data/checks_public.csv

      - name: Commit and push
        run: |
          git config user.name "sfb-bot"
          git config user.email "sfb-bot@users.noreply.github.com"
          git add data/locations.csv data/checks_public.csv docs/data/locations.csv docs/data/checks_public.csv
          # Add validation log if it exists (for debugging)
          [ -f data/validation_errors.log ] && git add data/validation_errors.log || true
          git diff --cached --quiet || git commit -m "Apply approved issues (v1)"
          git push

      - name: Comment on approved issue
        if: github.event_name == 'issues' && github.event.label.name == 'approved'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get issue body and labels
          ISSUE_BODY=$(gh issue view ${{ github.event.issue.number }} --json body -q '.body')
          LABELS=$(gh issue view ${{ github.event.issue.number }} --json labels -q '.labels[].name' | tr '\n' ' ')

          # Check if submission came via web form (has Submission ID)
          SUBMISSION_ID=$(echo "$ISSUE_BODY" | grep -oP 'Submission ID:\*\*\s*`\K[^`]+' || echo "")

          # Extract Location-ID from issue body (multiple formats)
          LOCATION_ID=$(echo "$ISSUE_BODY" | grep -oP 'Location-ID:\*\*\s*`\K[^`]+' || \
                        echo "$ISSUE_BODY" | grep -oP '### Location-ID\s*\n+\K[A-Z]{2}-[A-Z]{2}-\d+' || \
                        echo "$ISSUE_BODY" | grep -oP 'Location-ID\s*\n+\K[A-Z]{2}-[A-Z]{2}-\d+' || \
                        echo "$ISSUE_BODY" | grep -oP 'DE-BE-\d{5}' | head -1 || echo "")

          # Check if this is a critical change
          IS_CRITICAL=""
          if echo "$LABELS" | grep -q "critical"; then
            IS_CRITICAL="true"
          fi

          # Extract critical change reason
          CRITICAL_REASON=$(echo "$ISSUE_BODY" | grep -oP 'Was ist passiert\?\s*\n+\K[^\n]+' | head -1 || \
                           echo "$ISSUE_BODY" | grep -oP '### Was ist passiert\?\s*\n+\K[^\n]+' | head -1 || echo "")

          # Extract verification details for BTCMap notes
          # Support both formats: "### Label\n\nvalue" and "**Label:** value"
          CHECK_DATE=$(echo "$ISSUE_BODY" | grep -oP '### Datum und Uhrzeit[^\n]*\n+\K[^\n]+' | head -1 || \
                       echo "$ISSUE_BODY" | grep -oP 'Datum und Uhrzeit[^*]*\*\*\s*`?\K[^`\n]+' | head -1 || echo "")
          PUBLIC_POST=$(echo "$ISSUE_BODY" | grep -oP '### 1\. √ñffentlicher Post[^\n]*\n+\Khttps?://[^\n]+' | head -1 || \
                        echo "$ISSUE_BODY" | grep -oP '√ñffentlicher Post[^*]*\*\*\s*`?\K[^`\n]+' | head -1 || echo "")
          RECEIPT_URL=$(echo "$ISSUE_BODY" | grep -oP '### 2\. Kaufbeleg[^\n]*\n+\Khttps?://[^\n]+' | head -1 || \
                        echo "$ISSUE_BODY" | grep -oP '### 2\. Kaufnachweis[^\n]*\n+\Khttps?://[^\n]+' | head -1 || \
                        echo "$ISSUE_BODY" | grep -oP 'Kaufbeleg[^*]*\*\*\s*`?\K[^`\n]+' | head -1 || echo "")
          PAYMENT_URL=$(echo "$ISSUE_BODY" | grep -oP '### 3\. Bitcoin-Zahlung[^\n]*\n+\Khttps?://[^\n]+' | head -1 || \
                        echo "$ISSUE_BODY" | grep -oP 'Bitcoin-Zahlung[^*]*\*\*\s*`?\K[^`\n]+' | head -1 || echo "")
          VENUE_URL=$(echo "$ISSUE_BODY" | grep -oP '### 4\. Foto vom Ort[^\n]*\n+\Khttps?://[^\n]+' | head -1 || \
                      echo "$ISSUE_BODY" | grep -oP 'Foto vom Ort[^*]*\*\*\s*`?\K[^`\n]+' | head -1 || echo "")
          OBSERVATIONS=$(echo "$ISSUE_BODY" | grep -oP '### Wie lief die Zahlung[^\n]*\n+\K[^\n]+' | head -1 || \
                         echo "$ISSUE_BODY" | grep -oP 'Wie lief die Zahlung[^*]*\*\*\s*\K[^\n]+' | head -1 || echo "")

          # Look up OSM info from locations.csv using Python for proper CSV parsing
          BTCMAP_LINK=""
          OSM_LINK=""
          LOCATION_NAME=""
          if [ -n "$LOCATION_ID" ] && [ -f "data/locations.csv" ]; then
            OSM_INFO=$(python3 << EOF
          import csv
          location_id = "$LOCATION_ID"
          with open("data/locations.csv", newline="", encoding="utf-8") as f:
              for row in csv.DictReader(f):
                  if row.get("location_id") == location_id:
                      osm_type = row.get("osm_type", "")
                      osm_id = row.get("osm_id", "")
                      name = row.get("name", "").replace("|", " ")  # escape delimiter
                      print(f"{osm_type}|{osm_id}|{name}")
                      break
          EOF
          )
            if [ -n "$OSM_INFO" ]; then
              OSM_TYPE=$(echo "$OSM_INFO" | cut -d'|' -f1)
              OSM_ID=$(echo "$OSM_INFO" | cut -d'|' -f2)
              LOCATION_NAME=$(echo "$OSM_INFO" | cut -d'|' -f3)
              if [ -n "$OSM_TYPE" ] && [ -n "$OSM_ID" ]; then
                BTCMAP_LINK="https://btcmap.org/verify-location?id=${OSM_TYPE}:${OSM_ID}"
                OSM_LINK="https://www.openstreetmap.org/${OSM_TYPE}/${OSM_ID}"
              fi
            fi
          fi

          # Build BTCMap section for maintainer comment
          BTCMAP_SECTION=""
          if [ -n "$BTCMAP_LINK" ]; then
            ISSUE_URL="https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}"
            TODAY=$(date +%Y-%m-%d)

            if [ -n "$IS_CRITICAL" ]; then
              # Critical change - location no longer accepts Bitcoin
              BTCMAP_NOTES="CRITICAL: Location no longer accepts Bitcoin (reported ${TODAY})

          Reason: ${CRITICAL_REASON:-Location reported as not accepting Bitcoin anymore}

          Evidence: ${ISSUE_URL}"

              BTCMAP_SECTION="

          ---

          ### ‚ö†Ô∏è BTCMap aktualisieren (KRITISCH)

          **Dieser Ort akzeptiert kein Bitcoin mehr!**

          **[‚û°Ô∏è BTCMap √∂ffnen](${BTCMAP_LINK})**

          Bitte melde die √Ñnderung an BTCMap:
          1. Klicke auf den Link oben
          2. W√§hle \"Report outdated info\" oder \"No longer accepts Bitcoin\"
          3. Kopiere diesen Text als Begr√ºndung:

          \`\`\`
          ${BTCMAP_NOTES}
          \`\`\`

          <details>
          <summary>Links</summary>

          - [OSM-Eintrag](${OSM_LINK})
          - [GitHub Issue](${ISSUE_URL})
          </details>"
            else
              # Normal verification
              BTCMAP_NOTES="Verified via sats4berlin on ${TODAY}

          Proof:
          - Social: ${PUBLIC_POST:-n/a}
          - Receipt: ${RECEIPT_URL:-n/a}
          - Payment: ${PAYMENT_URL:-n/a}
          - Venue: ${VENUE_URL:-n/a}

          Full details: ${ISSUE_URL}"

              BTCMAP_SECTION="

          ---

          ### üó∫Ô∏è BTCMap aktualisieren

          **[‚û°Ô∏è BTCMap Verification √∂ffnen](${BTCMAP_LINK})**

          Kopiere diesen Text in das Feld \"Additional notes\":

          \`\`\`
          ${BTCMAP_NOTES}
          \`\`\`

          <details>
          <summary>Links</summary>

          - [OSM-Eintrag](${OSM_LINK})
          - [GitHub Issue](${ISSUE_URL})
          </details>"
            fi
          fi

          if [ -n "$IS_CRITICAL" ]; then
            # Critical change - location no longer accepts Bitcoin
            if [ -n "$SUBMISSION_ID" ]; then
              gh issue comment ${{ github.event.issue.number }} --body "## ‚ö†Ô∏è Kritische √Ñnderung best√§tigt!

          Deine Meldung wurde gepr√ºft und **best√§tigt**. Vielen Dank f√ºr die wichtige Info!

          **${LOCATION_NAME:-Der Ort}** wurde als \"akzeptiert kein Bitcoin mehr\" markiert.

          Die Auszahlung des Bounties erfolgt in K√ºrze an die von dir im Formular angegebene Adresse.
          ${BTCMAP_SECTION}

          ---
          *Automatische Nachricht von sats4berlin-bot*"
            else
              gh issue comment ${{ github.event.issue.number }} --body "## ‚ö†Ô∏è Kritische √Ñnderung best√§tigt!

          Deine Meldung wurde gepr√ºft und **best√§tigt**. Vielen Dank f√ºr die wichtige Info!

          **${LOCATION_NAME:-Der Ort}** wurde als \"akzeptiert kein Bitcoin mehr\" markiert.

          ### N√§chster Schritt: Auszahlungsziel mitteilen

          Bitte sende uns dein Auszahlungsziel **privat** per E-Mail oder Direktnachricht:
          - **Lightning-Adresse** (z.B. name@wallet.com)
          - oder **Cashu-Token-Anfrage**

          Kontakt f√ºr Auszahlung: satoshiinberlin@proton.me
          ${BTCMAP_SECTION}

          ---
          *Automatische Nachricht von sats4berlin-bot*"
            fi
          elif echo "$LABELS" | grep -q "new-location"; then
            # New location - payout held until confirmed
            gh issue comment ${{ github.event.issue.number }} --body "## ‚úÖ Check approved!

          Dein Check wurde gepr√ºft und **approved**.

          **Hinweis f√ºr Neueintr√§ge:** Die Auszahlung erfolgt erst, wenn **2 weitere Bitcoiner** den Ort durch einen eigenen Kauf best√§tigt haben (insgesamt 3 g√ºltige Checks).

          Sobald die Best√§tigungen vorliegen, erfolgt die Auszahlung automatisch an die von dir angegebene Adresse.
          ${BTCMAP_SECTION}

          ---
          *Automatische Nachricht von sats4berlin-bot*"
          elif [ -n "$SUBMISSION_ID" ]; then
            # Submitted via web form - contact info is stored privately
            gh issue comment ${{ github.event.issue.number }} --body "## ‚úÖ Check approved!

          Dein Check wurde gepr√ºft und **approved**. Vielen Dank!

          Die Auszahlung erfolgt in K√ºrze an die von dir im Formular angegebene Adresse.
          ${BTCMAP_SECTION}

          ---
          *Automatische Nachricht von sats4berlin-bot*"
          else
            # Submitted via GitHub form - need to request payout info
            gh issue comment ${{ github.event.issue.number }} --body "## ‚úÖ Check approved!

          Dein Check wurde gepr√ºft und **approved**. Vielen Dank!

          ### N√§chster Schritt: Auszahlungsziel mitteilen

          Bitte sende uns dein Auszahlungsziel **privat** per E-Mail oder Direktnachricht:
          - **Lightning-Adresse** (z.B. name@wallet.com)
          - oder **Cashu-Token-Anfrage**

          ‚ö†Ô∏è **Wichtig:** Poste deine Lightning-Adresse **nicht** √∂ffentlich in diesem Issue!

          Kontakt f√ºr Auszahlung: satoshiinberlin@proton.me
          ${BTCMAP_SECTION}

          ---
          *Automatische Nachricht von sats4berlin-bot*"
          fi
