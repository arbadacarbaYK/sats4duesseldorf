name: Mark check as paid

on:
  issues:
    types: [labeled]

# Prevent concurrent CSV writes - wait for other workflows to finish
concurrency:
  group: csv-write
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:
  mark-paid:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'paid'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update paid status in CSV
        run: |
          python3 << 'EOF'
          import csv
          import json
          from pathlib import Path
          import datetime

          CHECKS = Path("data/checks_public.csv")
          BUDGET = Path("data/budget.json")
          issue_number = "${{ github.event.issue.number }}"
          check_id = f"ISSUE-{issue_number}"
          today = datetime.date.today().isoformat()
          now = datetime.datetime.utcnow().isoformat() + "Z"

          rows, fields = [], []
          with CHECKS.open(newline="", encoding="utf-8") as f:
              r = csv.DictReader(f)
              fields = r.fieldnames
              rows = list(r)

          updated = False
          for row in rows:
              if row.get("check_id") == check_id:
                  row["paid_status"] = "paid"
                  row["paid_at"] = today
                  updated = True
                  print(f"Marked {check_id} as paid")
                  break

          if updated:
              with CHECKS.open("w", newline="", encoding="utf-8") as f:
                  w = csv.DictWriter(f, fieldnames=fields)
                  w.writeheader()
                  for row in rows:
                      w.writerow(row)

              # Recalculate budget from all paid checks
              total_paid = 0
              paid_count = 0
              for row in rows:
                  if row.get("paid_status") == "paid":
                      try:
                          total_paid += int(row.get("final_bounty_sats", 0) or 0)
                          paid_count += 1
                      except ValueError:
                          pass

              total_budget = 1000000
              budget_data = {
                  "total_budget_sats": total_budget,
                  "total_paid_sats": total_paid,
                  "remaining_sats": total_budget - total_paid,
                  "paid_count": paid_count,
                  "last_updated": now
              }
              with BUDGET.open("w", encoding="utf-8") as f:
                  json.dump(budget_data, f, indent=2)
              print(f"Budget updated: {total_paid} paid, {total_budget - total_paid} remaining")
          else:
              print(f"Check {check_id} not found in CSV")
          EOF

      - name: Commit and push
        run: |
          git config user.name "sfb-bot"
          git config user.email "sfb-bot@users.noreply.github.com"
          git add data/checks_public.csv data/budget.json
          git diff --cached --quiet || git commit -m "Mark ISSUE-${{ github.event.issue.number }} as paid"
          git push

      - name: Comment on issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "## ðŸ’° Bounty ausgezahlt!

          Die Auszahlung fÃ¼r diesen Check wurde verarbeitet.

          Vielen Dank fÃ¼r deinen Beitrag zu **Satoshis fÃ¼r Berlin**!

          ---
          *Automatische Nachricht von sats4berlin-bot*"

      - name: Close issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close ${{ github.event.issue.number }}
